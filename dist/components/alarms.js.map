{"version":3,"sources":["../../src/components/alarms.js"],"names":["config","appEvents","MonascaClient","AlarmsPageCtrl","$scope","$injector","$location","backendSrv","datasourceSrv","alertSrv","monasca","metricFilters","stateFilters","severityFilters","defIdFilters","totalFilters","editFilterIndex","alarmCount","temp","countAlarms","console","log","currentPage","pageSize","pageCount","Math","ceil","slicedAlarms","numberOfPages","alarms","length","search","dimensions","split","map","kv","k","v","metric_dimensions","id","pageLoaded","loadFailed","loadAlarms","suggestDimensionNames","_suggestDimensionNames","bind","suggestDimensionValues","_suggestDimensionValues","query","callback","listDimensionNames","then","filter","key","listDimensionValues","index","push","splice","every","f","value","refreshAlarms","i","alarm_definition_id","listAlarms","catch","set","err","message","firstIndex","secondIndex","slice","deleting","findIndex","n","find","setAlarmDeleting","deleteAlarm","alarmDeleted","alarm","emit","title","text","text2","name","yesText","icon","onConfirm","confirmDeleteAlarm","templateUrl"],"mappings":"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","file":"alarms.js","sourcesContent":["/*\n *   Copyright 2017 StackHPC\n *   (C) Copyright 2017 Hewlett Packard Enterprise Development LP\n *\n *   Licensed under the Apache License, Version 2.0 (the \"License\");\n *   you may not use this file except in compliance with the License.\n *   You may obtain a copy of the License at\n *\n *       http://www.apache.org/licenses/LICENSE-2.0\n *\n *   Unless required by applicable law or agreed to in writing, software\n *   distributed under the License is distributed on an \"AS IS\" BASIS,\n *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *   See the License for the specific language governing permissions and\n *   limitations under the License.\n */\n\nimport config from 'app/core/config';\nimport appEvents from 'app/core/app_events';\nimport MonascaClient from './monasca_client';\n\n\nexport class AlarmsPageCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, $location, backendSrv, datasourceSrv, alertSrv) {\n    this.alertSrv = alertSrv\n    this.monasca = new MonascaClient(backendSrv, datasourceSrv);\n\n    this.metricFilters = [];\n    this.stateFilters = [];\n    this.severityFilters = [];\n    this.defIdFilters = [];\n    this.totalFilters = [];\n\n    this.editFilterIndex = -1;\n    this.alarmCount = 0;\n\n    //Get alarm count\n    var temp = this.monasca.countAlarms();\n    console.log(temp);\n\n    this.currentPage = 0;\n    this.pageSize = 20;\n    this.pageCount = Math.ceil(this.alarmCount / this.pageSize);\n    console.log(this.pageCount);\n    this.slicedAlarms = [];\n\n    this.numberOfPages = function(){\n      return Math.ceil(this.alarms.length/this.pageSize);\n    }\n\n    if ('dimensions' in $location.search()) {\n      this.metricFilters = $location.search().dimensions\n\t.split(',')\n\t.map(kv => kv.split(':'))\n\t.map(([k, v]) => ({ metric_dimensions: k + \":\" + v }));\n    }\n\n    if ('id' in $location.search()){\n      this.defIdFilters[0] = $location.search().id;\n    }\n\n    this.pageLoaded = false;\n    this.loadFailed = false;\n    this.alarms = [];\n    this.loadAlarms();\n\n    this.suggestDimensionNames = this._suggestDimensionNames.bind(this);\n    this.suggestDimensionValues = this._suggestDimensionValues.bind(this);\n  }\n\n  _suggestDimensionNames(query, callback) {\n    this.monasca.listDimensionNames().then(callback);\n  }\n\n  _suggestDimensionValues(query, callback) {\n    var filter = this.metricFilters[this.editFilterIndex];\n    if (filter && filter.key) {\n      this.monasca.listDimensionValues(filter.key).then(callback);\n    }\n  }\n\n  editFilter(index) {\n    this.editFilterIndex = index;\n  }\n\n  //Metric Dimension Filter add/remove\n\n  addMetricFilter() {\n    this.metricFilters.push({});\n  }\n\n  removeMetricFilter(index) {\n    var filter = this.metricFilters[index];\n    this.metricFilters.splice(index, 1);\n  }\n\n  //State Filter add/remove\n\n  addStateFilter() {\n    this.stateFilters.push({});\n  }\n\n  removeStateFilter(index) {\n    var filter = this.stateFilters[index];\n    this.stateFilters.splice(index, 1);\n  }\n\n  //Severity Filter add/remove\n\n  addSeverityFilter() {\n    this.severityFilters.push({});\n  }\n\n  removeSeverityFilter(index) {\n    var filter = this.severityFilters[index];\n    this.severityFilters.splice(index, 1);\n  }\n\n  applyFilter() {\n    // Check filter is complete before applying.\n    if (this.metricFilters.every(function (f){\n        f.metric_dimensions = f.key + \":\" + f.value;\n        return f.metric_dimensions;\n    })){\n      this.refreshAlarms();\n      this.refreshAlarms();\n    }\n  }\n\n  refreshAlarms() {\n    if (this.pageLoaded) {\n      this.pageLoaded = false;\n      this.loadAlarms();\n      this.pageLoaded = true;\n    }\n  }\n\n  loadAlarms() {\n    this.totalFilters = [];\n    if (this.metricFilters){\n      for (var i = 0; i < this.metricFilters.length; i++){\n        this.totalFilters.push(this.metricFilters[i]);\n      }\n    }\n    if (this.stateFilters){\n      for (var i = 0; i < this.stateFilters.length; i++){\n        this.totalFilters.push(this.stateFilters[i]);\n      }\n    }\n    if (this.severityFilters){\n      for (var i = 0; i < this.severityFilters.length; i++){\n        this.totalFilters.push(this.severityFilters[i]);\n      }\n    }\n    if (this.defIdFilters){\n      var temp = {};\n      temp.alarm_definition_id = this.defIdFilters[0];\n      this.totalFilters.push(temp);\n      }\n\n    this.monasca.listAlarms(this.totalFilters).then(alarms => {\n      this.alarms = alarms;\n      this.slicedAlarms = alarms;\n    }).catch(err => {\n      this.alertSrv.set(\"Failed to get alarms.\", err.message, 'error', 10000);\n      this.loadFailed = true;\n    }).then(() => {\n      this.pageLoaded = true;\n    });\n  }\n\n  sliceAlarms(){\n    for(var i = 0; i < this.alarms.length; i++){\n      if(this.currentPage == i){\n        var firstIndex = this.pageSize * (i + 1);\n        var secondIndex = this.pageSize * (i + 2);\n        this.slicedAlarms = this.alarms.slice(firstIndex,secondIndex);\n      }\n    }\n  }\n\n  sliceReverse(){\n    for(var i = 0; i < this.alarms.length; i++){\n      if(this.currentPage == i){\n        var firstIndex = this.pageSize * (i - 1);\n        var secondIndex = this.pageSize * (i);\n        this.slicedAlarms = this.alarms.slice(firstIndex,secondIndex);\n      }\n    }\n  }\n\n  setAlarmDeleting(id, deleting) {\n    var index = this.alarms.findIndex(n => n.id === id);\n    if (index !== -1) {\n      this.alarms[index].deleting = true;\n    }\n  }\n\n  alarmDeleted(id) {\n    var index = this.alarms.find(n => n.id === id);\n    if (index !== -1) {\n      this.alarms.splice(index, 1);\n    }\n  }\n\n  confirmDeleteAlarm(id) {\n    this.setAlarmDeleting(id, true);\n\n    this.monasca.deleteAlarm(id).then(() => {\n      this.alarmDeleted(id);\n    }).catch(err => {\n      this.setAlarmDeleting(id, false);\n      this.alertSrv.set(\"Failed to delete alarm.\", err.message, 'error', 10000);\n    });\n  }\n\n  deleteAlarm(alarm) {\n    appEvents.emit('confirm-modal', {\n      title: 'Delete',\n      text: 'Are you sure you want to delete this alarm?',\n      text2: alarm.name,\n      yesText: \"Delete\",\n      icon: \"fa-trash\",\n      onConfirm: () => {\n        this.confirmDeleteAlarm(alarm.id);\n      }\n    });\n  }\n}\n\nAlarmsPageCtrl.templateUrl = 'components/alarms.html';\n"]}